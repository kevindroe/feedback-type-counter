<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feedback Type Analyzer</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #f6f7fb; color: #111; }
    .wrap { max-width: 1040px; margin: 0 auto; }
    .header { display:flex; align-items:center; gap: 14px; flex-wrap: wrap; }
    .logo { max-height: 70px; width: auto; }
    h1 { font-size: 22px; margin: 0; }
    .byline { margin: 2px 0 0; color:#444; font-size: 12.5px; }
    .sub { margin: 10px 0 14px; color: #444; font-size: 13px; line-height: 1.35; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 920px) { .grid { grid-template-columns: 1.1fr .9fr; } }

    .card { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    label { display:block; font-size: 12px; color:#444; margin: 0 0 4px; }
    input[type="text"], input[type="date"], input[type="number"], textarea {
      width: 100%; box-sizing: border-box;
      padding: 10px 12px; border-radius: 10px; border: 1px solid #d7dbe8;
      background: #fff; font-size: 14px;
    }
    input[type="number"] { max-width: 180px; }
    textarea { min-height: 120px; resize: vertical; }

    .row { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 920px) { .row.two { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 920px) { .row.three { grid-template-columns: 1fr 1fr 1fr; } }

    .topbar { display:flex; align-items: flex-end; justify-content: space-between; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
    .time { font-variant-numeric: tabular-nums; letter-spacing: .4px; }
    .big { font-size: 34px; font-weight: 900; }

    .pill { padding: 6px 10px; border-radius: 999px; background: #eef1ff; color: #2a3bb7; font-weight: 850; font-size: 12px; }
    .pill.off { background:#f0f2f8; color:#444; }
    .pill.on { background:#e9f7ef; color:#136a36; }

    .controls { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      border: 0; border-radius: 12px; padding: 10px 12px; font-weight: 850;
      cursor: pointer; background: #1e2330; color: #fff;
      touch-action: manipulation;
    }
    button.secondary { background: #e9ecf6; color: #111; }
    button.danger { background: #b11b2a; }
    button:disabled { opacity: .55; cursor:not-allowed; }

    .counters { display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
    @media (min-width: 920px) { .counters { grid-template-columns: 1fr 1fr; } }

    .counterBox{
      border: 1px solid #e3e6f2;
      border-radius: 14px;
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .counterBox .name { font-weight: 950; }
    .counterBox .desc { margin-top: 2px; font-size: 12px; color:#555; }
    .count { font-size: 34px; font-weight: 950; text-align:right; font-variant-numeric: tabular-nums; }
    .btnrow { display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; margin-top: 8px; }
    .btnrow button { padding: 10px 14px; }
    .bigTap { min-width: 90px; }

    /* === Different color for each category === */
    .c1 { background:#e8f2ff; border-color:#aecdff; }   /* light blue */
    .c2 { background:#fff1dc; border-color:#f4c788; }   /* light orange */
    .c3 { background:#e9f7ec; border-color:#a9e0b5; }   /* light green */
    .c4 { background:#f1e6ff; border-color:#d4b8ff; }   /* light purple */
    .c5 { background:#ffe6ef; border-color:#ffb4ce; }   /* light pink */

    .hint { font-size: 12px; color: #555; margin-top: 10px; }
    .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background:#f1f3fb; padding:2px 6px; border-radius:6px; border:1px solid #d7dbe8; }

    #output { min-height: 240px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; background: #fbfcff; white-space: pre; }
    .footer { font-size: 12px; color:#555; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <!-- Put the PNG in the same folder as this HTML file (GitHub Pages: same repo folder as index.html) -->
      <img class="logo" src="Next-Gen-Music-Ed-logo.png" alt="Next Gen Music Ed logo">
      <div>
        <h1>Feedback Type Analyzer</h1>
        <div class="byline">Developed by Kevin Droe, Ph.D.</div>
      </div>
    </div>

    <p class="sub">
      Use this to count what kind of feedback the teacher gives <em>after students perform</em>. Then export a clean summary to paste into an LMS or Google Form.
    </p>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row two">
          <div>
            <label for="observer">Observer name</label>
            <input id="observer" type="text" placeholder="Student observer" />
          </div>
          <div>
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>
        </div>

        <div class="row three" style="margin-top:10px;">
          <div>
            <label for="teacher">Observed teacher</label>
            <input id="teacher" type="text" placeholder="Teacher (optional)" />
          </div>
          <div>
            <label for="context">Context</label>
            <input id="context" type="text" placeholder="Rehearsal / lesson / sectional" />
          </div>
          <div>
            <label for="duration">Observation length (minutes)</label>
            <input id="duration" type="number" min="1" step="1" value="10" />
          </div>
        </div>

        <div class="topbar">
          <div>
            <div style="font-size:12px; color:#555;">Elapsed time</div>
            <div id="elapsed" class="time big">00:00.0</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <span id="targetPill" class="pill">Target: 10:00</span>
            <span id="statePill" class="pill off">Stopped</span>
          </div>
        </div>

        <div class="controls">
          <button id="startBtn">Start</button>
          <button id="stopBtn" class="secondary">Stop</button>
          <button id="resetBtn" class="danger">Reset</button>
          <button id="exportBtn">Export summary</button>
        </div>

        <div class="counters" id="counters"></div>

        <div style="margin-top:12px;">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Optional: examples you noticed, patterns, quotes, what happened right before feedback, etc."></textarea>
        </div>

        <div class="hint">
          Shortcuts:
          <span class="kbd">Space</span> Start/Stop timer •
          <span class="kbd">1</span> Specific musical •
          <span class="kbd">2</span> Corrective •
          <span class="kbd">3</span> General praise •
          <span class="kbd">4</span> Questioning •
          <span class="kbd">5</span> No feedback •
          <span class="kbd">Z</span> undo last count
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <label for="output">Export (copy/paste into LMS or Google Form)</label>
        <textarea id="output" placeholder="Click “Export summary” to generate a clean text block."></textarea>

        <div class="controls">
          <button id="copyBtn" class="secondary">Copy to clipboard</button>
          <button id="downloadBtn" class="secondary">Download CSV</button>
        </div>

        <div class="footer">
          Tip: Google Drive preview won’t run interactive HTML/JS. Use a normal browser tab (local file or GitHub Pages).
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const categories = [
    { id:"specific", label:"Specific musical feedback", desc:"Feedback names a musical element (pitch, rhythm, tone, balance, articulation, etc.).", colorClass:"c1" },
    { id:"corrective", label:"Corrective feedback", desc:"Correction, stop-and-fix, or directive improvement feedback.", colorClass:"c2" },
    { id:"praise", label:"General praise (“Good job”)", desc:"Non-specific positive feedback without musical detail.", colorClass:"c3" },
    { id:"questioning", label:"Questioning (eliciting thinking)", desc:"Questions that prompt student thinking/decision-making (\"What did you notice?\").", colorClass:"c4" },
    { id:"none", label:"No feedback after performance", desc:"Students perform and teacher gives no feedback before moving on.", colorClass:"c5" },
  ];

  const state = {
    running: false,
    startPerf: null,
    elapsedMs: 0,
    raf: null,
    counts: Object.fromEntries(categories.map(c => [c.id, 0])),
    history: [] // {id, t}
  };

  // Elements
  const observerEl = document.getElementById("observer");
  const teacherEl = document.getElementById("teacher");
  const contextEl = document.getElementById("context");
  const dateEl = document.getElementById("date");
  const durationEl = document.getElementById("duration");
  const notesEl = document.getElementById("notes");

  const elapsedEl = document.getElementById("elapsed");
  const targetPillEl = document.getElementById("targetPill");
  const statePillEl = document.getElementById("statePill");

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const resetBtn = document.getElementById("resetBtn");
  const exportBtn = document.getElementById("exportBtn");

  const countersEl = document.getElementById("counters");

  const outputEl = document.getElementById("output");
  const copyBtn = document.getElementById("copyBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  // default date
  dateEl.valueAsDate = new Date();

  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  function formatMs(ms) {
    const totalTenths = Math.floor(ms / 100);
    const tenths = totalTenths % 10;
    const totalSeconds = Math.floor(totalTenths / 10);
    const s = totalSeconds % 60;
    const m = Math.floor(totalSeconds / 60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${tenths}`;
  }

  function formatMsNoTenths(ms) {
    const totalSeconds = Math.round(ms / 1000);
    const s = totalSeconds % 60;
    const m = Math.floor(totalSeconds / 60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function updateTargetPill() {
    const mins = clamp(parseInt(durationEl.value || "10", 10), 1, 999);
    targetPillEl.textContent = `Target: ${formatMsNoTenths(mins * 60 * 1000)}`;
  }
  durationEl.addEventListener("change", updateTargetPill);
  updateTargetPill();

  function setRunUI() {
    statePillEl.textContent = state.running ? "Running" : "Stopped";
    statePillEl.className = `pill ${state.running ? "on" : "off"}`;
    startBtn.disabled = state.running;
    stopBtn.disabled = !state.running;
  }

  function renderCounters() {
    countersEl.innerHTML = "";
    categories.forEach((c, idx) => {
      const box = document.createElement("div");
      box.className = `counterBox ${c.colorClass}`;
      box.id = `box-${c.id}`;

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="name">${idx + 1}. ${c.label}</div>
        <div class="desc">${c.desc}</div>
        <div class="btnrow">
          <button class="bigTap" id="plus-${c.id}">+1</button>
          <button class="secondary" id="minus-${c.id}">-1</button>
        </div>
      `;

      const right = document.createElement("div");
      right.innerHTML = `<div class="count" id="count-${c.id}">${state.counts[c.id]}</div>`;

      box.appendChild(left);
      box.appendChild(right);
      countersEl.appendChild(box);

      document.getElementById(`plus-${c.id}`).addEventListener("click", () => increment(c.id));
      document.getElementById(`minus-${c.id}`).addEventListener("click", () => decrement(c.id));
    });
  }

  function paintCounts() {
    categories.forEach(c => {
      const el = document.getElementById(`count-${c.id}`);
      if (el) el.textContent = String(state.counts[c.id]);
    });
  }

  function increment(id) {
    state.counts[id] += 1;
    state.history.push({ id, t: Date.now() });
    paintCounts();
  }

  function decrement(id) {
    state.counts[id] = Math.max(0, state.counts[id] - 1);
    paintCounts();
  }

  function undoLast() {
    const last = state.history.pop();
    if (!last) return;
    state.counts[last.id] = Math.max(0, state.counts[last.id] - 1);
    paintCounts();
  }

  function tick(now) {
    if (!state.running) return;
    if (state.startPerf == null) state.startPerf = now;

    const dt = now - state.startPerf;
    state.startPerf = now;
    state.elapsedMs += dt;

    elapsedEl.textContent = formatMs(state.elapsedMs);

    const mins = clamp(parseInt(durationEl.value || "10", 10), 1, 999);
    const targetMs = mins * 60 * 1000;
    if (state.elapsedMs >= targetMs) {
      stop();
      state.elapsedMs = targetMs;
      elapsedEl.textContent = formatMs(state.elapsedMs);
    } else {
      state.raf = requestAnimationFrame(tick);
    }
  }

  function start() {
    if (state.running) return;
    state.running = true;
    state.startPerf = null;
    setRunUI();
    state.raf = requestAnimationFrame(tick);
  }

  function stop() {
    if (!state.running) return;
    state.running = false;
    if (state.raf) cancelAnimationFrame(state.raf);
    state.raf = null;
    state.startPerf = null;
    setRunUI();
  }

  function resetAll() {
    stop();
    state.elapsedMs = 0;
    elapsedEl.textContent = formatMs(0);
    for (const k of Object.keys(state.counts)) state.counts[k] = 0;
    state.history = [];
    paintCounts();
    outputEl.value = "";
    notesEl.value = "";
  }

  function exportSummary() {
    if (state.running) stop();

    const observer = observerEl.value.trim();
    const teacher = teacherEl.value.trim();
    const context = contextEl.value.trim();
    const dateVal = dateEl.value;

    const mins = clamp(parseInt(durationEl.value || "10", 10), 1, 999);
    const targetMs = mins * 60 * 1000;

    const totalCounts = Object.values(state.counts).reduce((a,b)=>a+b,0);
    const rates = (id) => {
      const minutesObserved = Math.max(0.001, (state.elapsedMs / 60000));
      return (state.counts[id] / minutesObserved).toFixed(2);
    };

    const lines = [];
    lines.push("FEEDBACK TYPE ANALYZER");
    lines.push("----------------------");
    lines.push("Developed by Kevin Droe, Ph.D.");
    lines.push("");
    if (observer) lines.push(`Observer: ${observer}`);
    if (dateVal) lines.push(`Date: ${dateVal}`);
    if (teacher) lines.push(`Observed teacher: ${teacher}`);
    if (context) lines.push(`Context: ${context}`);
    lines.push(`Target time: ${formatMsNoTenths(targetMs)}`);
    lines.push(`Observed time: ${formatMsNoTenths(state.elapsedMs)}`);
    lines.push("");

    lines.push(`Total feedback events counted: ${totalCounts}`);
    lines.push("");
    lines.push("Counts (#) and rate (per minute):");
    lines.push(`1. Specific musical feedback: ${state.counts.specific}  (rate: ${rates("specific")}/min)`);
    lines.push(`2. Corrective feedback: ${state.counts.corrective}  (rate: ${rates("corrective")}/min)`);
    lines.push(`3. General praise: ${state.counts.praise}  (rate: ${rates("praise")}/min)`);
    lines.push(`4. Questioning: ${state.counts.questioning}  (rate: ${rates("questioning")}/min)`);
    lines.push(`5. No feedback after performance: ${state.counts.none}  (rate: ${rates("none")}/min)`);

    const notes = notesEl.value.trim();
    if (notes) {
      lines.push("");
      lines.push("Notes:");
      lines.push(notes);
    }

    lines.push("");
    lines.push("One-line version (for Google Form short answer):");
    const one = [
      observer ? `Observer=${observer}` : null,
      dateVal ? `Date=${dateVal}` : null,
      teacher ? `Teacher=${teacher}` : null,
      context ? `Context=${context}` : null,
      `Time=${formatMsNoTenths(state.elapsedMs)}`,
      `Specific=${state.counts.specific}`,
      `Corrective=${state.counts.corrective}`,
      `Praise=${state.counts.praise}`,
      `Questioning=${state.counts.questioning}`,
      `NoFeedback=${state.counts.none}`
    ].filter(Boolean).join(" | ");
    lines.push(one);

    outputEl.value = lines.join("\n");
  }

  function downloadCSV() {
    if (state.running) stop();

    const headers = [
      "observer","date","observed_teacher","context",
      "target_mmss","observed_mmss",
      "specific_musical","corrective","general_praise","questioning","no_feedback",
      "notes"
    ];

    const mins = clamp(parseInt(durationEl.value || "10", 10), 1, 999);
    const targetMs = mins * 60 * 1000;

    const values = [
      observerEl.value.trim(),
      dateEl.value,
      teacherEl.value.trim(),
      contextEl.value.trim(),
      formatMsNoTenths(targetMs),
      formatMsNoTenths(state.elapsedMs),
      state.counts.specific,
      state.counts.corrective,
      state.counts.praise,
      state.counts.questioning,
      state.counts.none,
      notesEl.value.trim()
    ];

    const esc = (s) => {
      const str = (s ?? "").toString();
      if (/[",\n]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
      return str;
    };

    const csv = `${headers.join(",")}\n${values.map(esc).join(",")}\n`;
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const safe = (dateEl.value || "observation").replace(/[^0-9a-z]+/gi, "_");
    a.href = url;
    a.download = `feedback_type_${safe}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Buttons
  startBtn.addEventListener("click", start);
  stopBtn.addEventListener("click", stop);
  resetBtn.addEventListener("click", resetAll);
  exportBtn.addEventListener("click", exportSummary);

  copyBtn.addEventListener("click", async () => {
    const text = outputEl.value.trim();
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      copyBtn.textContent = "Copied!";
      setTimeout(() => (copyBtn.textContent = "Copy to clipboard"), 900);
    } catch {
      outputEl.focus();
      outputEl.select();
      document.execCommand("copy");
      copyBtn.textContent = "Copied!";
      setTimeout(() => (copyBtn.textContent = "Copy to clipboard"), 900);
    }
  });

  downloadBtn.addEventListener("click", downloadCSV);

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if (tag === "input" || tag === "textarea") return;

    if (e.code === "Space") { e.preventDefault(); state.running ? stop() : start(); return; }
    if (e.key === "1") increment("specific");
    if (e.key === "2") increment("corrective");
    if (e.key === "3") increment("praise");
    if (e.key === "4") increment("questioning");
    if (e.key === "5") increment("none");
    if (e.key.toLowerCase() === "z") undoLast();
  });

  // init
  renderCounters();
  paintCounts();
  setRunUI();
  elapsedEl.textContent = formatMs(0);
})();
</script>
</body>
</html>
