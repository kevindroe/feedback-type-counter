<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>Feedback Type Analyzer</title>

  <style>
    :root{
      --bg:#fff;
      --ink:#111827;
      --muted:#4b5563;
      --stroke: rgba(17,24,39,.12);
      --shadow: 0 10px 28px rgba(17,24,39,.10);
      --round:18px;

      /* soft pastels */
      --c1: rgba(59,130,246,.12);   --c1b: rgba(59,130,246,.25);   /* blue */
      --c2: rgba(245,158,11,.14);   --c2b: rgba(245,158,11,.28);   /* amber */
      --c3: rgba(16,185,129,.12);   --c3b: rgba(16,185,129,.26);   /* green */
      --c4: rgba(168,85,247,.12);   --c4b: rgba(168,85,247,.26);   /* purple */
      --c5: rgba(244,63,94,.10);    --c5b: rgba(244,63,94,.22);    /* rose */

      --btn:#111827; --btnInk:#fff;
      --btn2: rgba(17,24,39,.06);
      --dangerBg: rgba(220,38,38,.10);
      --dangerInk:#b91c1c;
      --dangerStroke: rgba(220,38,38,.25);
      --focus: rgba(59,130,246,.25);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 480px at 10% 0%, rgba(59,130,246,.10), transparent 55%),
        radial-gradient(700px 420px at 100% 12%, rgba(168,85,247,.10), transparent 55%),
        radial-gradient(700px 520px at 30% 100%, rgba(16,185,129,.08), transparent 55%),
        var(--bg);
      padding:16px;
    }
    .wrap{ max-width:1180px; margin:0 auto; }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px;
      border-radius: calc(var(--round) + 6px);
      background: rgba(255,255,255,.90);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .brand{ display:flex; align-items:center; gap:14px; min-width:260px; }
    .logo{
      height:58px; width:auto; object-fit:contain;
      filter: drop-shadow(0 10px 16px rgba(17,24,39,.16));
    }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .by{ margin-top:2px; font-size:12px; color:var(--muted); }

    .sub{
      margin: 10px 0 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width:980px){ .grid{ grid-template-columns: 1.06fr .94fr; } }

    .card{
      background: rgba(255,255,255,.90);
      border:1px solid var(--stroke);
      border-radius: var(--round);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(8px);
    }

    .row{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width:980px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input[type="text"], input[type="date"], input[type="number"], input[type="url"], select, textarea, input[type="file"]{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(17,24,39,.16);
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    textarea{ min-height:120px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px var(--focus);
    }
    input[type="number"]{ max-width:260px; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(17,24,39,.06);
      border:1px solid rgba(17,24,39,.10);
      font-weight:900;
      font-size:12px;
      color:var(--ink);
    }
    .chip.off{ color:var(--muted); background: rgba(17,24,39,.04); }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(17,24,39,.35); box-shadow:0 0 0 3px rgba(17,24,39,.06);}
    .dot.on{ background: rgba(16,185,129,.95); box-shadow:0 0 0 3px rgba(16,185,129,.14); }
    .dot.warn{ background: rgba(245,158,11,.95); box-shadow:0 0 0 3px rgba(245,158,11,.14); }

    .timerBar{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      background: rgba(17,24,39,.03);
      border:1px solid rgba(17,24,39,.08);
    }
    .timeLabel{ font-size:12px; color:var(--muted); }
    .timeBig{
      font-variant-numeric: tabular-nums;
      letter-spacing:.6px;
      font-size:34px;
      font-weight:950;
      line-height:1.05;
      margin-top:2px;
    }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:1px solid rgba(17,24,39,.14);
      background: var(--btn);
      color: var(--btnInk);
      padding:10px 12px;
      border-radius:14px;
      font-weight:950;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
      transition: transform .06s ease, filter .12s ease;
    }
    button:hover{ filter: brightness(1.04); }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: var(--btn2);
      color: var(--ink);
      border-color: rgba(17,24,39,.12);
    }
    button.danger{
      background: var(--dangerBg);
      color: var(--dangerInk);
      border-color: var(--dangerStroke);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .switch{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(17,24,39,.04);
      border:1px solid rgba(17,24,39,.10);
      user-select:none;
    }
    .switch input{ width:18px; height:18px; accent-color: rgb(59,130,246); }

    .videoBox{
      margin-top:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(17,24,39,.10);
      background: rgba(17,24,39,.02);
    }
    video, iframe{
      width:100%;
      aspect-ratio:16/9;
      border-radius:14px;
      background:#000;
      border:1px solid rgba(17,24,39,.10);
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.12);
      color: rgba(17,24,39,.92);
      font-size:12px;
      line-height:1.35;
      display:none;
    }

    .counters{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:14px; }
    @media (min-width:980px){ .counters{ grid-template-columns:1fr 1fr; } }

    .counterCard{
      border-radius:18px;
      border:1px solid rgba(17,24,39,.12);
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
    }
    .tone1{ background: linear-gradient(180deg, var(--c1), rgba(255,255,255,.72)); border-color: var(--c1b); }
    .tone2{ background: linear-gradient(180deg, var(--c2), rgba(255,255,255,.72)); border-color: var(--c2b); }
    .tone3{ background: linear-gradient(180deg, var(--c3), rgba(255,255,255,.72)); border-color: var(--c3b); }
    .tone4{ background: linear-gradient(180deg, var(--c4), rgba(255,255,255,.72)); border-color: var(--c4b); }
    .tone5{ background: linear-gradient(180deg, var(--c5), rgba(255,255,255,.72)); border-color: var(--c5b); }

    .cName{ font-weight:950; letter-spacing:.2px; }
    .cDesc{ margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35; }
    .cRight{ display:grid; gap:8px; justify-items:end; }
    .cCount{ font-size:30px; font-weight:950; font-variant-numeric: tabular-nums; }
    .cMini{ font-size:12px; color:var(--muted); font-weight:900; }

    .btnMiniRow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .btnMiniRow button{ padding:9px 10px; }

    .log{
      margin-top:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(17,24,39,.10);
      background: rgba(17,24,39,.02);
      max-height:380px;
      overflow:auto;
    }
    .logHeader{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .logTitle{ font-weight:950; }
    .logSmall{ font-size:12px; color:var(--muted); }
    .logItem{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border-radius:14px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(17,24,39,.10);
      margin-bottom:10px;
    }
    .tstamp{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      background: rgba(17,24,39,.04);
      border:1px solid rgba(17,24,39,.08);
      font-variant-numeric: tabular-nums;
      color: rgba(17,24,39,.92);
    }
    .logCat{ font-weight:950; }
    .logMeta{ font-size:12px; color: rgba(17,24,39,.65); margin-top:2px; }
    .jumpBtn{ padding:9px 10px; border-radius:14px; }

    #output{
      min-height:220px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      white-space: pre;
      background:#fff;
    }

    .kbd{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(17,24,39,.12);
      background: rgba(17,24,39,.04);
    }
    .tip{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.35; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <img class="logo" src="Next-Gen-Music-Ed-logo.png" alt="Next Gen Music Ed logo">
      <div>
        <h1>Feedback Type Analyzer</h1>
        <div class="by">Developed by Kevin Droe, Ph.D.</div>
      </div>
    </div>
    <div class="chips">
      <span class="chip" id="modeChip"><span class="dot warn" id="modeDot"></span><span id="modeText">Live mode</span></span>
      <span class="chip off" id="syncChip"><span class="dot" id="syncDot"></span><span id="syncText">Sync: Off</span></span>
      <span class="chip off" id="stateChip"><span class="dot" id="stateDot"></span><span id="stateText">Stopped</span></span>
    </div>
  </div>

  <div class="sub">
    Count feedback types following student performance. Works live or with video; in video mode, each event can “Jump” back to that timestamp.
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row two">
        <div>
          <label for="observer">Observer name</label>
          <input id="observer" type="text" placeholder="Your name" />
        </div>
        <div>
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="row three" style="margin-top:10px;">
        <div>
          <label for="teacher">Observed teacher</label>
          <input id="teacher" type="text" placeholder="Teacher name (optional)" />
        </div>
        <div>
          <label for="context">Context / class</label>
          <input id="context" type="text" placeholder="Lesson / rehearsal / class period" />
        </div>
        <div>
          <label for="duration">Target observation length (minutes)</label>
          <input id="duration" type="number" min="1" step="1" value="10" />
        </div>
      </div>

      <div class="videoBox">
        <div class="row two">
          <div>
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="live">Live Observation</option>
              <option value="video">Video Observation</option>
            </select>
          </div>
          <div style="display:flex; align-items:end; justify-content:flex-end;">
            <div class="switch">
              <input id="sync" type="checkbox">
              <span style="font-weight:950;">Sync observation to playback</span>
            </div>
          </div>
        </div>

        <div id="videoControls" style="display:none; margin-top:10px;">
          <div class="row two">
            <div>
              <label for="videoFile">Case B — Upload video file</label>
              <input id="videoFile" type="file" accept="video/*" />
            </div>
            <div>
              <label for="ytUrl">Case A — Paste YouTube URL</label>
              <input id="ytUrl" type="url" placeholder="https://www.youtube.com/watch?v=..." />
            </div>
          </div>

          <div class="btnrow">
            <button id="loadYt" class="secondary">Load YouTube</button>
            <button id="clearVideo" class="secondary">Clear video</button>
          </div>

          <div id="ytMsg" class="msg"></div>

          <div style="margin-top:10px;">
            <div id="localWrap" style="display:none;">
              <video id="video" controls playsinline></video>
            </div>
            <div id="ytWrap" style="display:none;">
              <div id="ytPlayer"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="timerBar">
        <div>
          <div class="timeLabel">Elapsed time</div>
          <div id="elapsed" class="timeBig">00:00.0</div>
        </div>
        <div class="chips" style="justify-content:flex-end;">
          <span id="targetChip" class="chip">Target: 10:00</span>
          <span id="timeChip" class="chip off">Time: 00:00</span>
        </div>
      </div>

      <div class="btnrow">
        <button id="start">Start observation</button>
        <button id="stop" class="secondary">Stop observation</button>
        <button id="reset" class="danger">Reset</button>
        <button id="export">Export summary</button>
      </div>

      <div class="counters" id="counters"></div>

      <div class="btnrow">
        <button id="undo" class="secondary">Undo last event</button>
        <button id="clearLog" class="secondary">Clear log</button>
      </div>

      <div style="margin-top:12px;">
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Notes (examples, patterns, reflections, context)…"></textarea>
      </div>

      <div class="tip">
        Shortcuts:
        <span class="kbd">Space</span> Start/Stop •
        <span class="kbd">1</span> Specific •
        <span class="kbd">2</span> Corrective •
        <span class="kbd">3</span> Praise •
        <span class="kbd">4</span> Questioning •
        <span class="kbd">5</span> No feedback •
        <span class="kbd">Z</span> Undo •
        <span class="kbd">E</span> Export
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="logHeader">
        <div>
          <div class="logTitle">Event Log</div>
          <div class="logSmall">Each +1 is logged with a timestamp. In video mode, use <b>Jump</b> to seek.</div>
        </div>
        <div class="chips" style="justify-content:flex-end;">
          <span class="chip off" id="jumpHelp">Jump requires video</span>
        </div>
      </div>

      <div class="log" id="log"></div>

      <div style="margin-top:12px;">
        <label for="output">Export (copy/paste into LMS or Google Form)</label>
        <textarea id="output" placeholder="Click “Export summary” to generate a clean report."></textarea>
      </div>

      <div class="btnrow">
        <button id="copy" class="secondary">Copy to clipboard</button>
        <button id="csv" class="secondary">Download CSV</button>
        <button id="jsonOut" class="secondary">Export Log JSON</button>
        <button id="jsonInBtn" class="secondary">Import Log JSON</button>
        <input id="jsonIn" type="file" accept="application/json" style="display:none;">
      </div>

      <div class="tip">
        Tip: Google Drive preview won’t run interactive HTML/JS. Use GitHub Pages or download and open locally in a browser.
      </div>
    </div>
  </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
(() => {
  // Categories (counters)
  const categories = [
    {
      id: "specific",
      key: "1",
      label: "1. Specific musical feedback",
      desc: "Feedback names a musical element (pitch, rhythm, tone, balance, articulation, etc.).",
      tone: "tone1"
    },
    {
      id: "corrective",
      key: "2",
      label: "2. Corrective feedback",
      desc: "Correction, stop-and-fix, or directive improvement feedback.",
      tone: "tone2"
    },
    {
      id: "praise",
      key: "3",
      label: "3. General praise (“Good job”)",
      desc: "Non-specific positive feedback without musical detail.",
      tone: "tone3"
    },
    {
      id: "questioning",
      key: "4",
      label: "4. Questioning (eliciting thinking)",
      desc: "Questions that prompt student thinking/decision-making (\"What did you notice?\").",
      tone: "tone4"
    },
    {
      id: "none",
      key: "5",
      label: "5. No feedback after performance",
      desc: "Students perform and teacher gives no feedback before moving on.",
      tone: "tone5"
    }
  ];

  const el = {
    observer: document.getElementById("observer"),
    date: document.getElementById("date"),
    teacher: document.getElementById("teacher"),
    context: document.getElementById("context"),
    duration: document.getElementById("duration"),
    notes: document.getElementById("notes"),

    mode: document.getElementById("mode"),
    sync: document.getElementById("sync"),

    videoControls: document.getElementById("videoControls"),
    videoFile: document.getElementById("videoFile"),
    ytUrl: document.getElementById("ytUrl"),
    loadYt: document.getElementById("loadYt"),
    clearVideo: document.getElementById("clearVideo"),
    ytMsg: document.getElementById("ytMsg"),
    localWrap: document.getElementById("localWrap"),
    ytWrap: document.getElementById("ytWrap"),
    video: document.getElementById("video"),

    elapsed: document.getElementById("elapsed"),
    targetChip: document.getElementById("targetChip"),
    timeChip: document.getElementById("timeChip"),

    start: document.getElementById("start"),
    stop: document.getElementById("stop"),
    reset: document.getElementById("reset"),
    export: document.getElementById("export"),
    undo: document.getElementById("undo"),
    clearLog: document.getElementById("clearLog"),

    counters: document.getElementById("counters"),
    log: document.getElementById("log"),

    output: document.getElementById("output"),
    copy: document.getElementById("copy"),
    csv: document.getElementById("csv"),
    jsonOut: document.getElementById("jsonOut"),
    jsonInBtn: document.getElementById("jsonInBtn"),
    jsonIn: document.getElementById("jsonIn"),

    modeText: document.getElementById("modeText"),
    modeDot: document.getElementById("modeDot"),
    syncText: document.getElementById("syncText"),
    syncDot: document.getElementById("syncDot"),
    syncChip: document.getElementById("syncChip"),
    stateText: document.getElementById("stateText"),
    stateDot: document.getElementById("stateDot"),
    stateChip: document.getElementById("stateChip"),
    jumpHelp: document.getElementById("jumpHelp")
  };

  el.date.valueAsDate = new Date();

  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function fmtMs(ms){
    const totalTenths = Math.floor(ms/100);
    const tenths = totalTenths % 10;
    const totalSeconds = Math.floor(totalTenths/10);
    const s = totalSeconds % 60;
    const m = Math.floor(totalSeconds/60);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${tenths}`;
  }
  function fmtSec(sec){
    if (!isFinite(sec) || sec < 0) return "N/A";
    const s = Math.floor(sec);
    const mm = Math.floor(s/60);
    const ss = s % 60;
    return `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
  }

  const state = {
    running:false,
    raf:null,

    // live clock
    liveStartPerf:null,
    liveElapsedMs:0,

    counts: Object.fromEntries(categories.map(c => [c.id, 0])),

    // event log
    events: [],

    // undo stack of snapshots
    history: [],

    // video
    videoMode: "none", // none|local|youtube
    ytPlayer:null,
    ytReady:false
  };

  // ---------- Chips ----------
  function setModeChip(){
    const m = el.mode.value;
    el.modeText.textContent = (m==="live") ? "Live mode" : "Video mode";
    el.modeDot.className = "dot " + (m==="live" ? "warn" : "on");
  }
  function setSyncChip(){
    const on = !!el.sync.checked;
    el.syncText.textContent = `Sync: ${on ? "On" : "Off"}`;
    el.syncChip.className = "chip " + (on ? "" : "off");
    el.syncDot.className = "dot " + (on ? "on" : "");
  }
  function setStateChip(){
    el.stateText.textContent = state.running ? "Running" : "Stopped";
    el.stateChip.className = "chip " + (state.running ? "" : "off");
    el.stateDot.className = "dot " + (state.running ? "on" : "");
    el.start.disabled = state.running;
    el.stop.disabled = !state.running;
  }
  function setJumpHelp(){
    const ok = (el.mode.value==="video") && (state.videoMode==="local" || state.videoMode==="youtube");
    el.jumpHelp.textContent = ok ? "Jump enabled" : "Jump requires video";
    el.jumpHelp.className = "chip " + (ok ? "" : "off");
  }
  function updateTarget(){
    const mins = clamp(parseInt(el.duration.value || "10", 10), 1, 999);
    el.targetChip.textContent = `Target: ${fmtSec(mins*60)}`;
  }
  el.duration.addEventListener("change", updateTarget);
  updateTarget();

  // ---------- Video helpers ----------
  function showYtMsg(text){
    el.ytMsg.textContent = text;
    el.ytMsg.style.display = text ? "block" : "none";
  }
  function setVideoMode(mode){
    state.videoMode = mode;
    el.localWrap.style.display = (mode==="local") ? "" : "none";
    el.ytWrap.style.display = (mode==="youtube") ? "" : "none";
    setJumpHelp();
  }
  function clearLocalVideo(){
    try{ el.video.pause(); }catch{}
    el.video.removeAttribute("src");
    el.video.load();
    el.videoFile.value = "";
  }
  function destroyYt(){
    if (state.ytPlayer){
      try{ state.ytPlayer.destroy(); }catch{}
      state.ytPlayer = null;
    }
    state.ytReady = false;
  }
  function parseYouTubeId(url){
    try{
      const u = new URL(url);
      if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
      if (u.searchParams.get("v")) return u.searchParams.get("v");
      const parts = u.pathname.split("/");
      const i = parts.indexOf("embed");
      if (i>=0 && parts[i+1]) return parts[i+1];
      return "";
    }catch{ return ""; }
  }

  el.videoFile.addEventListener("change", () => {
    const f = el.videoFile.files && el.videoFile.files[0];
    if (!f) return;
    destroyYt();
    el.ytUrl.value = "";
    showYtMsg("");
    const url = URL.createObjectURL(f);
    el.video.src = url;
    setVideoMode("local");
  });

  el.loadYt.addEventListener("click", () => {
    const id = parseYouTubeId(el.ytUrl.value.trim());
    if (!id){ alert("Could not read a YouTube video ID from that link."); return; }
    clearLocalVideo();
    destroyYt();
    showYtMsg("");
    document.getElementById("ytPlayer").innerHTML = "";
    setVideoMode("youtube");

    try{
      state.ytPlayer = new YT.Player("ytPlayer", {
        videoId: id,
        playerVars: { playsinline:1, rel:0, modestbranding:1, origin: window.location.origin },
        events: {
          onReady: () => { state.ytReady = true; },
          onError: () => {
            state.ytReady = false;
            showYtMsg("This YouTube video can’t be embedded (or a player configuration error occurred). Please use Upload Video instead (Case B).");
          },
          onStateChange: (ev) => {
            if (el.mode.value!=="video" || !el.sync.checked) return;
            if (ev.data === 1) startObservation();                // play
            if (ev.data === 2 || ev.data === 0) stopObservation(); // pause/end
          }
        }
      });
    }catch{
      showYtMsg("YouTube couldn’t be loaded. Please use Upload Video instead (Case B).");
    }
  });

  el.clearVideo.addEventListener("click", () => {
    clearLocalVideo();
    destroyYt();
    el.ytUrl.value = "";
    showYtMsg("");
    setVideoMode("none");
  });

  el.video.addEventListener("play", () => {
    if (el.mode.value!=="video" || !el.sync.checked) return;
    startObservation();
  });
  el.video.addEventListener("pause", () => {
    if (el.mode.value!=="video" || !el.sync.checked) return;
    stopObservation();
  });
  el.video.addEventListener("ended", () => {
    if (el.mode.value!=="video" || !el.sync.checked) return;
    stopObservation();
  });

  function currentTimeSec(){
    if (el.mode.value==="live") return state.liveElapsedMs/1000;
    if (state.videoMode==="local") return el.video.currentTime || 0;
    if (state.videoMode==="youtube"){
      if (state.ytReady && state.ytPlayer && state.ytPlayer.getCurrentTime) return state.ytPlayer.getCurrentTime() || 0;
      return NaN;
    }
    return NaN;
  }

  // ---------- Observation timer ----------
  function startObservation(){
    if (state.running) return;
    state.running = true;
    if (el.mode.value==="live") state.liveStartPerf = null;
    setStateChip();
    state.raf = requestAnimationFrame(tick);
  }

  function stopObservation(){
    if (!state.running) return;
    state.running = false;
    if (state.raf) cancelAnimationFrame(state.raf);
    state.raf = null;
    state.liveStartPerf = null;
    setStateChip();
    updateTimeChip();
  }

  function tick(now){
    if (!state.running) return;

    if (el.mode.value==="live"){
      if (state.liveStartPerf == null) state.liveStartPerf = now;
      const dt = now - state.liveStartPerf;
      state.liveStartPerf = now;
      state.liveElapsedMs += dt;

      const mins = clamp(parseInt(el.duration.value || "10", 10), 1, 999);
      const targetMs = mins * 60 * 1000;
      if (state.liveElapsedMs >= targetMs){
        state.liveElapsedMs = targetMs;
        stopObservation();
        el.elapsed.textContent = fmtMs(state.liveElapsedMs);
        return;
      }
      el.elapsed.textContent = fmtMs(state.liveElapsedMs);
    } else {
      const sec = currentTimeSec();
      el.elapsed.textContent = isFinite(sec) ? fmtMs(sec*1000) : "00:00.0";
    }

    updateTimeChip();
    state.raf = requestAnimationFrame(tick);
  }

  function updateTimeChip(){
    const sec = currentTimeSec();
    el.timeChip.textContent = "Time: " + (isFinite(sec) ? fmtSec(sec) : "N/A");
    el.timeChip.className = "chip " + (isFinite(sec) ? "" : "off");
  }

  // ---------- Counters + logging ----------
  function snapshotForUndo(){
    state.history.push({
      liveElapsedMs: state.liveElapsedMs,
      counts: { ...state.counts },
      eventsLen: state.events.length
    });
  }

  function logEvent(catId, delta){
    const tSec = currentTimeSec();
    const cat = categories.find(c => c.id===catId);
    state.events.push({
      tSec: isFinite(tSec) ? tSec : null,
      tText: isFinite(tSec) ? fmtSec(tSec) : "N/A",
      catId,
      catLabel: cat ? cat.label.replace(/^\d+\.\s*/,"") : catId,
      delta,
      source: (el.mode.value==="live") ? "live" : state.videoMode
    });
  }

  function increment(catId){
    snapshotForUndo();
    if (!state.running) startObservation();
    state.counts[catId] += 1;
    logEvent(catId, +1);
    paintCounts();
    renderLog();
  }

  function decrement(catId){
    if ((state.counts[catId] || 0) <= 0) return;
    snapshotForUndo();
    // Do NOT auto-start on -1; it’s a correction.
    state.counts[catId] = Math.max(0, state.counts[catId] - 1);
    logEvent(catId, -1);
    paintCounts();
    renderLog();
  }

  function undo(){
    const snap = state.history.pop();
    if (!snap) return;
    state.liveElapsedMs = snap.liveElapsedMs;
    state.counts = { ...snap.counts };
    state.events = state.events.slice(0, snap.eventsLen);
    paintCounts();
    renderLog();
    el.elapsed.textContent = (el.mode.value==="live") ? fmtMs(state.liveElapsedMs) : (isFinite(currentTimeSec()) ? fmtMs(currentTimeSec()*1000) : "00:00.0");
    updateTimeChip();
  }

  function clearLog(){
    state.events = [];
    state.history = [];
    renderLog();
  }

  function buildCountersOnce(){
    el.counters.innerHTML = "";
    categories.forEach((c) => {
      const card = document.createElement("div");
      card.className = `counterCard ${c.tone}`;

      const left = document.createElement("div");
      left.innerHTML = `<div class="cName">${c.label}</div><div class="cDesc">${c.desc}</div>`;

      const right = document.createElement("div");
      right.className = "cRight";

      const count = document.createElement("div");
      count.className = "cCount";
      count.id = `count-${c.id}`;
      count.textContent = "0";

      const mini = document.createElement("div");
      mini.className = "cMini";
      mini.id = `mini-${c.id}`;
      mini.textContent = "Events: 0";

      const btns = document.createElement("div");
      btns.className = "btnMiniRow";

      const plus = document.createElement("button");
      plus.textContent = "+1";
      plus.addEventListener("click", () => increment(c.id));

      const minus = document.createElement("button");
      minus.textContent = "-1";
      minus.className = "secondary";
      minus.addEventListener("click", () => decrement(c.id));

      btns.appendChild(plus);
      btns.appendChild(minus);

      right.appendChild(count);
      right.appendChild(mini);
      right.appendChild(btns);

      card.appendChild(left);
      card.appendChild(right);
      el.counters.appendChild(card);
    });
    paintCounts();
  }

  function paintCounts(){
    categories.forEach(c => {
      const n = state.counts[c.id] || 0;
      const countEl = document.getElementById(`count-${c.id}`);
      const miniEl  = document.getElementById(`mini-${c.id}`);
      if (countEl) countEl.textContent = String(n);
      if (miniEl)  miniEl.textContent = `Count: ${n}`;
    });
  }

  function canJump(){
    return (el.mode.value==="video") && (state.videoMode==="local" || state.videoMode==="youtube");
  }

  function jumpTo(sec){
    if (!canJump() || !isFinite(sec) || sec == null) return;
    if (state.videoMode==="local"){
      el.video.currentTime = sec;
      el.video.play().catch(()=>{});
    } else if (state.videoMode==="youtube"){
      if (state.ytReady && state.ytPlayer && state.ytPlayer.seekTo){
        state.ytPlayer.seekTo(sec, true);
        try{ state.ytPlayer.playVideo(); }catch{}
      }
    }
  }

  function renderLog(){
    setJumpHelp();
    el.log.innerHTML = "";

    if (state.events.length === 0){
      el.log.innerHTML = `<div style="color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}; font-size:12px;">No events logged yet.</div>`;
      return;
    }

    state.events.slice().reverse().forEach((ev) => {
      const item = document.createElement("div");
      item.className = "logItem";

      const t = document.createElement("div");
      t.className = "tstamp";
      t.textContent = ev.tText;

      const mid = document.createElement("div");
      const sign = (ev.delta === -1) ? "−1" : "+1";
      mid.innerHTML = `<div class="logCat">${ev.catLabel} <span style="color:rgba(17,24,39,.65); font-weight:900;">(${sign})</span></div><div class="logMeta">Source: ${ev.source}</div>`;

      const btn = document.createElement("button");
      btn.className = "secondary jumpBtn";
      btn.textContent = "Jump";
      btn.disabled = !(canJump() && isFinite(ev.tSec) && ev.tSec != null);
      btn.addEventListener("click", () => jumpTo(ev.tSec));

      item.appendChild(t);
      item.appendChild(mid);
      item.appendChild(btn);
      el.log.appendChild(item);
    });

    el.log.scrollTop = 0;
  }

  // ---------- Export ----------
  function exportSummary(){
    stopObservation();

    const mins = clamp(parseInt(el.duration.value || "10", 10), 1, 999);
    const mode = el.mode.value;
    const source = (mode==="live") ? "live stopwatch" : (state.videoMode==="local" ? "local video" : state.videoMode==="youtube" ? "YouTube" : "no video loaded");

    const observed = (mode==="live") ? fmtSec(state.liveElapsedMs/1000) : (isFinite(currentTimeSec()) ? fmtSec(currentTimeSec()) : "N/A");

    const lines = [];
    lines.push("FEEDBACK TYPE ANALYZER");
    lines.push("----------------------");
    lines.push("Developed by Kevin Droe, Ph.D.");
    lines.push("");
    const observer = el.observer.value.trim();
    const dateVal = el.date.value;
    const teacher = el.teacher.value.trim();
    const context = el.context.value.trim();
    if (observer) lines.push(`Observer: ${observer}`);
    if (dateVal) lines.push(`Date: ${dateVal}`);
    if (teacher) lines.push(`Observed teacher: ${teacher}`);
    if (context) lines.push(`Context/Class: ${context}`);
    lines.push(`Mode: ${mode}`);
    lines.push(`Video source: ${source}`);
    if (mode==="video" && el.ytUrl.value.trim()) lines.push(`YouTube URL: ${el.ytUrl.value.trim()}`);
    lines.push(`Target length (min): ${mins}`);
    lines.push(`Observed time: ${observed}`);
    lines.push("");

    lines.push("Counts (#):");
    categories.forEach(c => {
      lines.push(`- ${c.label.replace(/^\d+\.\s*/,"")}: ${state.counts[c.id]}`);
    });

    const notes = el.notes.value.trim();
    if (notes){
      lines.push("");
      lines.push("Notes:");
      lines.push(notes);
    }

    lines.push("");
    lines.push("Event log (most recent first):");
    if (state.events.length===0) lines.push("(No events logged)");
    else state.events.slice().reverse().forEach(ev => {
      const sign = (ev.delta === -1) ? "−1" : "+1";
      lines.push(`${ev.tText} — ${ev.catLabel} (${sign})`);
    });

    lines.push("");
    lines.push("One-line version:");
    lines.push([
      observer ? `Observer=${observer}` : null,
      dateVal ? `Date=${dateVal}` : null,
      teacher ? `Teacher=${teacher}` : null,
      context ? `Context=${context}` : null,
      `Mode=${mode}`,
      `Time=${observed}`,
      ...categories.map(c => `${c.id}=${state.counts[c.id]}`)
    ].filter(Boolean).join(" | "));

    el.output.value = lines.join("\n");
  }

  // ---------- CSV / JSON ----------
  function downloadCSV(){
    stopObservation();

    const mins = clamp(parseInt(el.duration.value || "10", 10), 1, 999);
    const mode = el.mode.value;
    const timeSource = (mode==="live") ? "live" : state.videoMode;

    const headers = [
      "observer","date","observed_teacher","context",
      "target_minutes","mode","time_source","youtube_url",
      ...categories.map(c => `${c.id}_count`),
      "notes",
      "event_time","event_category","event_delta","event_source"
    ];

    const base = [
      el.observer.value.trim(),
      el.date.value,
      el.teacher.value.trim(),
      el.context.value.trim(),
      mins,
      mode,
      timeSource,
      el.ytUrl.value.trim() || ""
    ];

    categories.forEach(c => base.push(state.counts[c.id]));
    base.push(el.notes.value.trim());

    const esc = (s) => {
      const str = (s ?? "").toString();
      if (/[",\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
      return str;
    };

    const rows = [];
    if (state.events.length===0){
      rows.push([...base,"","","",""].map(esc).join(","));
    } else {
      state.events.forEach(ev => {
        rows.push([...base, ev.tText, ev.catLabel, ev.delta, ev.source].map(esc).join(","));
      });
    }

    const csv = `${headers.join(",")}\n${rows.join("\n")}\n`;
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const safe = (el.date.value || "observation").replace(/[^0-9a-z]+/gi,"_");
    a.href = url;
    a.download = `feedback_type_analyzer_${safe}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportJSON(){
    stopObservation();
    const payload = {
      app: "Feedback Type Analyzer",
      developed_by: "Kevin Droe, Ph.D.",
      version: "1.1",
      exported_at: new Date().toISOString(),
      metadata: {
        observer: el.observer.value.trim(),
        date: el.date.value,
        observed_teacher: el.teacher.value.trim(),
        context: el.context.value.trim(),
        target_minutes: clamp(parseInt(el.duration.value || "10", 10), 1, 999),
        mode: el.mode.value,
        time_source: (el.mode.value==="live") ? "live" : state.videoMode,
        youtube_url: el.ytUrl.value.trim() || null
      },
      counts: { ...state.counts },
      notes: el.notes.value.trim(),
      events: state.events.slice()
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const safe = (el.date.value || "observation").replace(/[^0-9a-z]+/gi,"_");
    a.href = url;
    a.download = `feedback_type_analyzer_${safe}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function importJSONFile(file){
    try{
      const data = JSON.parse(await file.text());
      if (!data || !data.counts || !Array.isArray(data.events)) throw new Error("Invalid");

      stopObservation();

      el.observer.value = data.metadata?.observer || "";
      el.date.value = data.metadata?.date || el.date.value;
      el.teacher.value = data.metadata?.observed_teacher || "";
      el.context.value = data.metadata?.context || "";
      el.duration.value = data.metadata?.target_minutes ?? el.duration.value;
      updateTarget();

      el.mode.value = (data.metadata?.mode === "video") ? "video" : "live";
      applyModeUI();

      // counts
      categories.forEach(c => {
        if (typeof data.counts[c.id] === "number") state.counts[c.id] = Math.max(0, data.counts[c.id]);
        else state.counts[c.id] = 0;
      });

      el.notes.value = data.notes || "";
      state.events = data.events.slice();
      state.history = [];

      paintCounts();
      renderLog();

      const yt = data.metadata?.youtube_url;
      if (yt){
        el.ytUrl.value = yt;
        el.mode.value = "video";
        applyModeUI();
        el.loadYt.click();
      } else {
        if (el.mode.value==="video" && state.videoMode==="none"){
          showYtMsg("Load the same video to enable Jump.");
        }
      }
    }catch{
      alert("Could not import that JSON file.");
    } finally {
      el.jsonIn.value = "";
    }
  }

  // ---------- Mode switching ----------
  function applyModeUI(){
    stopObservation();
    setModeChip();
    setSyncChip();

    if (el.mode.value==="video"){
      el.videoControls.style.display = "";
      el.sync.disabled = false;
    } else {
      el.videoControls.style.display = "none";
      el.sync.checked = false;
      setSyncChip();
    }
    setJumpHelp();
    updateTimeChip();
  }

  // ---------- UI actions ----------
  el.start.addEventListener("click", startObservation);
  el.stop.addEventListener("click", stopObservation);

  el.reset.addEventListener("click", () => {
    stopObservation();
    state.liveElapsedMs = 0;
    state.counts = Object.fromEntries(categories.map(c => [c.id, 0]));
    state.events = [];
    state.history = [];
    el.output.value = "";
    el.notes.value = "";
    paintCounts();
    renderLog();
    el.elapsed.textContent = fmtMs(0);
    updateTimeChip();
  });

  el.export.addEventListener("click", exportSummary);

  el.copy.addEventListener("click", async () => {
    const text = el.output.value.trim();
    if (!text) return;
    try{
      await navigator.clipboard.writeText(text);
      el.copy.textContent = "Copied!";
      setTimeout(()=> el.copy.textContent="Copy to clipboard", 900);
    }catch{
      el.output.focus(); el.output.select();
      document.execCommand("copy");
      el.copy.textContent = "Copied!";
      setTimeout(()=> el.copy.textContent="Copy to clipboard", 900);
    }
  });

  el.csv.addEventListener("click", downloadCSV);
  el.jsonOut.addEventListener("click", exportJSON);
  el.jsonInBtn.addEventListener("click", () => el.jsonIn.click());
  el.jsonIn.addEventListener("change", () => {
    const f = el.jsonIn.files && el.jsonIn.files[0];
    if (f) importJSONFile(f);
  });

  el.undo.addEventListener("click", undo);
  el.clearLog.addEventListener("click", clearLog);

  el.mode.addEventListener("change", applyModeUI);
  el.sync.addEventListener("change", setSyncChip);
  el.duration.addEventListener("change", updateTarget);

  // ---------- Keyboard shortcuts ----------
  window.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if (tag==="input" || tag==="textarea" || tag==="select") return;

    if (e.code==="Space"){ e.preventDefault(); state.running ? stopObservation() : startObservation(); return; }
    if (e.key === "1") increment("specific");
    if (e.key === "2") increment("corrective");
    if (e.key === "3") increment("praise");
    if (e.key === "4") increment("questioning");
    if (e.key === "5") increment("none");
    if (e.key.toLowerCase()==="z"){ e.preventDefault(); undo(); }
    if (e.key.toLowerCase()==="e"){ e.preventDefault(); exportSummary(); }
  });

  // ---------- Init ----------
  function init(){
    setModeChip();
    setSyncChip();
    setStateChip();
    setVideoMode("none");
    el.videoControls.style.display = "none";
    el.sync.checked = false;
    el.elapsed.textContent = fmtMs(0);
    updateTimeChip();
    buildCountersOnce();
    renderLog();
  }

  init();
})();
</script>
</body>
</html>
